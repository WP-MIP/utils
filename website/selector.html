<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PREVENT CACHING: These tags force the browser to reload the page from the server -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>WP-MIP Data Portal: Data Selector</title>
    <link rel="stylesheet" href="styles-new.css">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --light-gray: #f4f4f4;
            --border-color: #ddd;
            --disabled-color: #999;
        }

        /* body { */
        /*     font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; */
        /*     margin: 0; */
        /*     padding: 20px; */
        /*     background-color: #fff; */
        /*     color: #333; */
        /* } */

        /* --- No Script Alert --- */
        noscript {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .noscript-msg {
            background: #e74c3c;
            color: white;
            padding: 2rem;
            border-radius: 8px;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
        }

        /* --- Layout --- */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .left-col {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-col {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- Panels --- */
        .panel {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .panel h3 {
            margin-top: 0;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 10px;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-actions a {
            font-size: 0.8em;
            text-decoration: none;
            color: var(--accent);
            margin-left: 10px;
            cursor: pointer;
        }
        .panel-actions a:hover { text-decoration: underline; }

        .info-text {
            font-size: 0.85em;
            color: var(--disabled-color);
            font-weight: normal;
            margin-left: 10px;
        }

        /* --- Left Column Specifics --- */
        .radio-group label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        /* Tooltip logic */
        .tooltip {
            border-bottom: 1px dotted #333;
            cursor: help;
        }

        /* --- Tables --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: var(--light-gray);
            text-align: left;
        }
        /* First column alignment */
        td:first-child, th:first-child { text-align: left; font-weight: bold;}

        /* --- Grid Checkboxes (Vars, Levels, Months) --- */
        .checkbox-grid {
            display: grid;
            gap: 5px;
        }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input:disabled + span {
            color: var(--disabled-color);
            text-decoration: line-through;
        }
        a.disabled {
            color: var(--disabled-color);
        }
        
        .checkbox-item label {
            margin-left: 5px;
            cursor: pointer;
        }

        div.disabled label {
            color: var(--disabled-color);
        }
        
        .checkbox-item label.disabled {
            color: var(--disabled-color);
       }
        .checkbox-item label .disabled {
            color: var(--disabled-color);
       }

        /* --- Output Text Boxes --- */
        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            resize: vertical;
        }
        
        .copy-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .copy-btn:hover { background-color: #2980b9; }

    </style>
</head>
<body>
  
    <main class="main-content">

    <!-- NEW NAVIGATION BAR -->
    <nav class="top-nav">
        <div class="nav-inner">
            <a href="index.html" class="nav-link">Home</a>
            <!-- Grouping the data links for clarity, though they work individually too -->
            <a href="selector.html" class="nav-link active">Data Selector</a>
            <a href="static.html" class="nav-link">Data Browsing</a>
            
            <!-- This link moves to the far right via CSS -->
            <a href="https://www.wcrp-esmo.org/activities/wp-mip" class="nav-link nav-right">WP-MIP Info Page ↗</a>
        </div>
    </nav>

    <header class="site-header">
        <div class="header-inner">
            <div class="logo">
                <a href="index.html">
                    <img src="https://hpfx.collab.science.gc.ca/~swpm001/wpmip_logo-2.png" alt="WP-MIP Logo">
                </a>
            </div>
            <div class="site-title">
                <h1>WP-MIP Data Portal</h1>
            </div>
        </div>
    </header>


    <noscript>
        <div class="noscript-msg">
            ⚠️ Alert: JavaScript is not enabled.<br>
            This application requires JavaScript to function properly.
        </div>
    </noscript>

    <div class="container main-container">
        <!-- LEFT COLUMN -->
        <div class="left-col">
            
            <!-- Product Type -->
            <div class="panel">
                <h3>Product type</h3>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="product_type" value="analyses" checked> 
                        Analyses
                    </label>
                    <label>
                        <input type="radio" name="product_type" value="forecasts_oic"> 
                        Forecasts <span class="tooltip" title="Own Initial Condition">OIC</span>
                    </label>
                    <label>
                        <input type="radio" name="product_type" value="forecasts_sic"> 
                        Forecasts <span class="tooltip" title="Same (ECMWF) Initial Conditions">SIC</span>
                    </label>
                </div>
            </div>
            
            <!-- Protocol Type -->
            <div class="panel" id="panel-provider">
                <h3>Protocol type</h3>
                <div class="radio-group" id="protocol-content">
                    <!-- <label> -->
                    <!--     <input type="radio" name="protocol_type" value="core" checked disabled> -->
                    <!--     <span class="tooltip" title="Core protocol desc">Core</span> -->
                    <!-- </label> -->
                    <!-- <label> -->
                    <!--     <input type="radio" name="protocol_type" value="sp1" disabled>  -->
                    <!--     <span class="tooltip" title="SP1 protocol desc">SP1</span> -->
                    <!-- </label> -->
                    <!-- <label> -->
                    <!--     <input type="radio" name="protocol_type" value="sp2" disabled>  -->
                    <!--     <span class="tooltip" title="SP1 protocol desc">SP1</span> -->
                    <!-- </label> -->
                </div>
            </div>

            <!-- Level Type -->
            <div class="panel">
                <h3>Level type</h3>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="level_type" value="sl"> 
                        Single Level
                    </label>
                    <label>
                        <input type="radio" name="level_type" value="pl" checked> 
                        Pressure
                    </label>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN -->
        <div class="right-col">

            <!-- Panel 1: Provider and Model Type -->
            <div class="panel" id="panel-provider">
                <div class="panel-actions" style="float:right">
                    <a onclick="selectAll('provider_table', true)">Select All</a>
                    <a onclick="selectAll('provider_table', false)">Clear</a>
                </div>
                <h3>Provider and Model Type</h3>
                <div id="provider-content">Loading data...</div>
            </div>

            <!-- Panel 2: Model Version -->
            <div class="panel" id="panel-version" style="display:none;">
                <!--  <div class="panel-actions" style="float:right"> -->
                <!--     <a onclick="selectAll('version_table', true)">Select All</a> -->
                <!--     <a onclick="selectAll('version_table', false)">Clear</a> -->
                <!-- </div> -->
                <h3>Model Version</h3>
                <div id="version-content"></div>
            </div>

            <!-- Panel 3: Variables -->
            <div class="panel" id="panel-vars">
                <div class="panel-actions" style="float:right">
                    <a onclick="selectAll('vars-content', true)">Select All</a>
                    <a onclick="selectAll('vars-content', false)">Clear</a>
                </div>
                <h3>Variables <span id="var-msg" class="info-text"></span></h3>
                <div id="vars-content" class="checkbox-grid grid-2"></div>
            </div>

            <!-- Panel 4: Levels -->
            <div class="panel" id="panel-levels" style="display:none;">
                <div class="panel-actions" style="float:right">
                    <a onclick="selectAll('levels-content', true)">Select All</a>
                    <a onclick="selectAll('levels-content', false)">Clear</a>
                </div>
                <h3>Levels <span id="lvl-msg" class="info-text"></span></h3>
                <div id="levels-content" class="checkbox-grid grid-4"></div>
            </div>

            <!-- Panel 5: Months -->
            <div class="panel" id="panel-months">
                <div class="panel-actions" style="float:right">
                    <a onclick="selectAll('months-content', true)">Select All</a>
                    <a onclick="selectAll('months-content', false)">Clear</a>
                </div>
                <h3>Months <span id="mon-msg" class="info-text"></span></h3>
                <div id="months-content" class="checkbox-grid grid-4"></div>
            </div>

            <!-- Output: Paths -->
            <div class="panel">
                <h3>Download Command <span id="path-count" class="info-text">(0 items)</span> <button class="copy-btn" title="copy to clipboard" onclick="copyToClipboard('out-paths')">Copy</button></h3>
                <textarea id="out-paths" readonly></textarea>
            </div>

            <!-- <\!-- Output: VPaths -\-> -->
            <!-- <div class="panel"> -->
            <!--     <h3>VPaths <span id="vpath-count" class="info-text">(0 items)</span> <button class="copy-btn" title="copy to clipboard" onclick="copyToClipboard('out-vpaths')">Copy</button></h3> -->
            <!--     <textarea id="out-vpaths" readonly></textarea> -->
            <!-- </div> -->

        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let jsonData = null;
        let state = {
            af: 'analyses',
            sss: 'oic',
            lvltype: 'pl',
            protocol: 'Core',
            
            // Selections
            sel_provider_model: new Set(), // Format: af:sss:cccc:mm
            sel_version: new Set(),        // Format: af:sss:cccc:mm:ii
            sel_vars: new Set(),           // varnames
            sel_levels: new Set(),         // values
            sel_months: new Set()          // values
        };

        // --- HELPER: Split and Purge Blanks ---
        function cleanSplit(str) {
            if (!str || typeof str !== 'string') return [];
            // Split by space and filter out any resulting empty strings
            return str.split(' ').filter(item => item.trim() !== '');
        }

        function sortNumRevert(l) {
             l.sort((a, b) => a - b);
             return l;
        }

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            fetchData();
            setupLeftColListeners();
        });

        async function fetchData() {
            try {
                // Cache busting parameter to ensure re-read
                const url = 'content.json?t=' + new Date().getTime();
                const response = await fetch(url);
                if (!response.ok) throw new Error("Failed to load content.json");
                jsonData = await response.json();
                
                // Helper Arrays splitting with purge logic
                jsonData.arr_cccc = cleanSplit(jsonData.allcccc);
                jsonData.arr_mm = cleanSplit(jsonData.allmm);
                jsonData.arr_ii = cleanSplit(jsonData.allii);
                jsonData.arr_slvar = cleanSplit(jsonData.allslvar);
                jsonData.arr_plvar = cleanSplit(jsonData.allplvar);
                jsonData.arr_lvl = cleanSplit(jsonData.alllvl).sort((a, b) => b - a);
                jsonData.arr_mon = cleanSplit(jsonData.allmon);

                // Initial Render
                updateProductType();  // Sets state af/sss
                updateLevelType();    // Sets state lvltype
                updateProtocolType(); // Sets state protocol
                renderProtocolPanel();
                renderProviderPanel();
                
            } catch (e) {
                document.querySelector('.right-col').innerHTML = `<div class="panel" style="color:red">Error: ${e.message}. Ensure content.json is present and you are running on a web server.</div>`;
                console.error(e);
            }
        }

        // --- LEFT COLUMN HANDLERS ---
        function setupLeftColListeners() {
            const productRadios = document.getElementsByName('product_type');
            productRadios.forEach(r => r.addEventListener('change', () => {
                updateProductType();
                // Reset downstream
                state.sel_provider_model.clear();
                state.sel_version.clear();
                state.sel_vars.clear();
                state.sel_levels.clear();
                state.sel_months.clear();
                updateProtocolType();
                renderProviderPanel();
                renderVersionPanel();
                renderVariablesPanel();
                renderLevelsPanel();
                renderMonthsPanel();
                generateOutputs();
            }));

            const levelRadios = document.getElementsByName('level_type');
            levelRadios.forEach(r => r.addEventListener('change', () => {
                updateLevelType();
                state.sel_provider_model.clear();
                state.sel_version.clear();
                state.sel_vars.clear();
                state.sel_levels.clear(); 
                state.sel_months.clear();
                renderProviderPanel();
                renderVersionPanel();
                renderVariablesPanel();
                renderLevelsPanel();
                renderMonthsPanel();
                generateOutputs();
            }));
        }

        function updateProductType() {
            const val = document.querySelector('input[name="product_type"]:checked').value;
            if (val === 'analyses') {
                state.af = 'analyses';
                state.sss = 'oic';
            } else if (val === 'forecasts_oic') {
                state.af = 'forecasts';
                state.sss = 'oic';
            } else {
                state.af = 'forecasts';
                state.sss = 'sic';
            }
        }
      
       function updateProtocolType() {
           const prodDiv = document.getElementById('protocol-type');          
           if (state.af === 'analyses') {
               state.protocol = 'Core';
           } else {
               state.protocol = document.querySelector('input[name="protocol_type"]:checked').value;
           }
           state.sel_provider_model.clear();
           state.sel_version.clear();
           state.sel_vars.clear();
           state.sel_levels.clear();
           state.sel_months.clear();
            renderProtocolPanel();
           renderProviderPanel();
           renderVersionPanel();
           renderVariablesPanel();
           renderLevelsPanel();
           renderMonthsPanel();
           generateOutputs();
        }

        function updateLevelType() {
            state.lvltype = document.querySelector('input[name="level_type"]:checked').value;
            const lvlPanel = document.getElementById('panel-levels');
            if (state.lvltype === 'pl') {
                lvlPanel.style.display = 'block';
            } else {
                lvlPanel.style.display = 'none';
            }
        }

        // --- VALIDATION FUNCTIONS ---

      function validate_cccc_mm_ii(af, sss, cccc, mm, ii) {
            // Check existence of path up to ii
            if (!jsonData.data[af] || 
                !jsonData.data[af][sss] || 
                !jsonData.data[af][sss][cccc] || 
                !jsonData.data[af][sss][cccc][mm] || 
                !jsonData.data[af][sss][cccc][mm][ii]) {
                return false;
            }

            const varList = (state.lvltype === 'sl') ? jsonData.arr_slvar : jsonData.arr_plvar;
            let isValid = false;

            // Check varnames
            for (let v of varList) {
                const varObj = jsonData.data[af][sss][cccc][mm][ii][v];
                if (!varObj) continue; // Var doesn't exist
isValid = true;
                if (state.lvltype === 'sl') {
                    if (varObj.lvllist.trim() === 'surface') {
                        isValid = true;
                        break; 
                    }
                } else {
                    // pl
                    if (varObj.lvllist.trim() !== 'surface') {
                        isValid = true;
                        break;
                    }
                }
            }

            //check protocol
           if (isValid && state.protocol !== 'Core') {
               isValid = false;
               const k = af+'/'+sss+'/'+cccc+'/'+mm+'_'+ii;
               if (jsonData['protocol'] && jsonData['protocol'][k]) {
                   const l = cleanSplit(jsonData.protocol[k]);
                   isValid = l.includes(state.protocol.toLowerCase());
               }
            }
          
            return isValid;
        }

        // --- RENDERERS ---

        function getLabel(key) {
            return (jsonData.dico && jsonData.dico[key]) ? jsonData.dico[key] : key;
        }

        function renderProtocolPanel() {
            const proto_types = ["Core", "SP1", "SP2"];
            const proto_href = {
                "Core": "https://docs.google.com/document/d/1d6hh2C2YXvGsqgB6mnjhCEsjjHTHLz_HHqwcyqIX-ug/edit?tab=t.0#heading=h.qggl5jknjrf5",
                "SP1" : "https://docs.google.com/document/d/1d6hh2C2YXvGsqgB6mnjhCEsjjHTHLz_HHqwcyqIX-ug/edit?tab=t.0#heading=h.8z5nrqdkx6lp",
                "SP2" : "https://docs.google.com/document/d/1d6hh2C2YXvGsqgB6mnjhCEsjjHTHLz_HHqwcyqIX-ug/edit?tab=t.0#heading=h.n4cqlzp1y04s"
            };
            const container = document.getElementById('protocol-content');
            let html = '';

            const isEnabled = (state.af !== 'analyses');
            const disabledAttr = isEnabled ? '' : 'disabled';
            if (!isEnabled) state.protocol = 'Core';
            proto_types.forEach((pt, index) => {
                const checkedAttr = (state.protocol === pt) ? 'checked' : '';
                const pt_href = proto_href[pt];
                html += `<label>
                         <input type="radio" name="protocol_type" value="${pt}" ${disabledAttr} ${checkedAttr} onchange="updateProtocolType()">
                         <a href="${pt_href}" target="_blank" class="${disabledAttr}">${pt}</a>
                         </label>`;
            });
            container.innerHTML = html;
        }

        function renderProviderPanel() {
            const container = document.getElementById('provider-content');
            let html = '<table id="provider_table"><thead><tr><th>Provider \\ Model</th>';
            
            // Header: MM
            jsonData.arr_mm.forEach(mm => {
                html += `<th>${getLabel(mm)}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Rows: CCCC
            jsonData.arr_cccc.forEach(cccc => {
                html += `<tr><td>${getLabel(cccc)}</td>`;
                jsonData.arr_mm.forEach(mm => {
                    const valid = validate_cccc_mm_ii(state.af, state.sss, cccc, mm, '00');
                    html += '<td>';
                    if (valid) {
                        val = `${state.af}:${state.sss}:${cccc}:${mm}`;
                        html += `<input type="checkbox" value="${val}" onchange="onProviderSelect()">`;
                    }
                    html += '</td>';
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Clear selections when re-rendered
            state.sel_provider_model.clear();
            renderVersionPanel(); // cascade clear
        }

        function onProviderSelect() {
            const checkboxes = document.querySelectorAll('#provider_table input[type="checkbox"]');
            state.sel_provider_model.clear();
            checkboxes.forEach(cb => {
                if(cb.checked) state.sel_provider_model.add(cb.value);
            });
            state.sel_vars.clear();
            state.sel_levels.clear(); 
            state.sel_months.clear();
            renderVersionPanel();
            renderVariablesPanel();
            renderLevelsPanel();
            renderMonthsPanel();
            generateOutputs();
       }

        function renderVersionPanel() {
            const verPanel = document.getElementById('panel-version');
            const container = document.getElementById('version-content');
            state.sel_version.clear(); // Rebuild logic

            if (state.sel_provider_model.size === 0) {
                container.innerHTML = '<div class="info-text">Select a provider above</div>';
                 verPanel.style.display = 'none';
                renderVariablesPanel();
                return;
            }

            let html = '<table id="version_table"><thead><tr><th>Provider-Model \\ Version</th>';
            jsonData.arr_ii.forEach(ii => {
                // html += `<th>${getLabel(ii)}</th>`;
                html += `<th></th>`;
            });
            html += '</tr></thead><tbody>';

            let visibleRowCount = 0;
            const rows = Array.from(state.sel_provider_model);

            rows.forEach(rowVal => {
                // rowVal = af:sss:cccc:mm
                const parts = rowVal.split(':');
                const cccc = parts[2];
                const mm = parts[3];
                
                // Calculate valid columns
                let validCols = [];
                jsonData.arr_ii.forEach(ii => {
                    if (validate_cccc_mm_ii(state.af, state.sss, cccc, mm, ii)) {
                        validCols.push(ii);
                    }
                });

                if (validCols.length === 1) {
                    // Hidden row, auto-select
                    const ii = validCols[0];
                    state.sel_version.add(`${rowVal}:${ii}`);
                } else if (validCols.length > 1) {
                    // Visible row
                    visibleRowCount++;
                    const rowLabel = `${getLabel(cccc)} - ${getLabel(mm)}`;
                    html += `<tr><td>${rowLabel}</td>`;
                    let rdstatus = "checked";
                    jsonData.arr_ii.forEach(ii => {
                        html += '<td>';
                        if (validCols.includes(ii)) {
                             const val = `${rowVal}:${ii}`;
                             // Default checked
                             // html += `<input type="checkbox" value="${val}" ${rdstatus} onchange="onVersionSelect()"> ${ii}`;
                             html += `<input type="radio" name="${rowVal}_bt" value="${val}" ${rdstatus} onchange="onVersionSelect()"> ${ii}`;
                            if (rdstatus != "") state.sel_version.add(val);
                            rdstatus = "";
                        }
                        html += '</td>';
                    });
                    html += '</tr>';
                }
            });

            html += '</tbody></table>';

            if (visibleRowCount === 0) {
                container.innerHTML = '<div class="info-text">Automatic version selection applied.</div>';
                container.style.display = 'hidden';
                verPanel.style.display = 'none';
            } else {
                container.innerHTML = html;
                container.style.display = 'block';
                verPanel.style.display = 'block';
            }

            renderVariablesPanel();
        }

        function onVersionSelect() {
            const newSet = new Set();
            
            // Add from visible checkboxes
            //const checkboxes = document.querySelectorAll('#version_table input[type="checkbox"]');
            // checkboxes.forEach(cb => {
            //     if(cb.checked) newSet.add(cb.value);
            // });
            const radioboxes = document.querySelectorAll('#version_table input[type="radio"]:checked');
            radioboxes.forEach(rb => {
                if(rb.checked) newSet.add(rb.value);
            });

            // Add hidden ones (re-run logic to capture hidden rows)
            const rows = Array.from(state.sel_provider_model);
            rows.forEach(rowVal => {
                const parts = rowVal.split(':');
                const cccc = parts[2]; const mm = parts[3];
                let validCols = [];
                jsonData.arr_ii.forEach(ii => {
                    if (validate_cccc_mm_ii(state.af, state.sss, cccc, mm, ii)) validCols.push(ii);
                });
                if (validCols.length === 1) {
                    newSet.add(`${rowVal}:${validCols[0]}`);
                }
            });

            state.sel_version = newSet;
            state.sel_vars.clear();
            state.sel_levels.clear(); 
            state.sel_months.clear();
            renderVariablesPanel();
            renderLevelsPanel();
            renderMonthsPanel();
            generateOutputs();
       }

        // Generic Valid Check for Var, Lvl, Mon against the Selection Tree
        function checkTreeExistence(varname, lvl=null, mon=null) {
            // Check if this var exists in ANY of the selected version paths
            
            for (let path of state.sel_version) {
                const p = path.split(':'); // af, sss, cccc, mm, ii
                const af=p[0], sss=p[1], cccc=p[2], mm=p[3], ii=p[4];
                
                const varNode = jsonData.data?.[af]?.[sss]?.[cccc]?.[mm]?.[ii]?.[varname];
                
                if (varNode) {
                    const isSurface = (varNode.lvllist.trim() === 'surface');
                    
                    if (state.lvltype === 'sl' && !isSurface) continue;
                    if (state.lvltype === 'pl' && isSurface) continue;

                    // If we are checking specific level or month existence
                    if (lvl) {
                        const lvlArr = cleanSplit(varNode.lvllist);
                        if (!lvlArr.includes(lvl)) continue;
                    }
                    
                    if (mon) {
                        const monArr = cleanSplit(varNode.monlist);
                        if (!monArr.includes(mon)) continue;
                    }

                    return true; // Found at least one valid path
                }
            }
            return false;
        }

        function renderVariablesPanel() {
            const container = document.getElementById('vars-content');
            const msg = document.getElementById('var-msg');
            
            const varList = (state.lvltype === 'sl') ? jsonData.arr_slvar : jsonData.arr_plvar;
            let allDisabled = true;

            let html = '';
            varList.forEach(v => {
                const isEnabled = checkTreeExistence(v);
                if (isEnabled) allDisabled = false;
                
                const disabledAttr = isEnabled ? '' : 'disabled';
                if (!isEnabled && state.sel_vars.has(v)) {
                    state.sel_vars.delete(v);
                }
                
                const checkedAttr = (isEnabled && state.sel_vars.has(v)) ? 'checked' : '';

                // Label logic
                let labelText = v;
                let link = '#';
                if (jsonData.vardict && jsonData.vardict[v]) {
                    labelText = jsonData.vardict[v].long + ' (' +v+ ') [' + jsonData.vardict[v].units + ']';
                    link = `https://codes.ecmwf.int/grib/param-db/${jsonData.vardict[v].id}`;
                }

                html += `<div class="checkbox-item" id="div_var_${v}">
                            <input type="checkbox" value="${v}" ${disabledAttr} ${checkedAttr} onchange="onVarSelect()">
                            <label><a href="${link}" target="_blank" class="${disabledAttr}">${labelText}</a></label>
                         </div>`;
            });

            container.innerHTML = html;
            msg.innerText = allDisabled ? "(Make a selection above to enable checkboxes)" : "";

            renderLevelsPanel();
            renderMonthsPanel();
            generateOutputs();
        }

        function onVarSelect() {
            const checkboxes = document.querySelectorAll('#vars-content input[type="checkbox"]');
            state.sel_vars.clear();
            checkboxes.forEach(cb => {
                if(cb.checked) state.sel_vars.add(cb.value);
            });
            state.sel_levels.clear(); 
            state.sel_months.clear();
            renderLevelsPanel();
            renderMonthsPanel();
            generateOutputs();
        }

        function renderLevelsPanel() {
            // If lvltype is sl, skip this panel (handled in updateLevelType toggle display)
            // But we must maintain state.sel_levels = 'surface'
            if (state.lvltype === 'sl') {
                state.sel_levels.clear();
                state.sel_levels.add('surface');
                return;
            }

            const container = document.getElementById('levels-content');
            const msg = document.getElementById('lvl-msg');
            
            let allDisabled = true;
            let html = '';

            jsonData.arr_lvl.forEach(lvl => {
                let isEnabled = false;
                for (let v of state.sel_vars) {
                     if (checkTreeExistence(v, lvl, null)) {
                         isEnabled = true;
                         break;
                     }
                }

                if (isEnabled) allDisabled = false;
                const disabledAttr = isEnabled ? '' : 'disabled';
                if (!isEnabled && state.sel_levels.has(lvl)) state.sel_levels.delete(lvl);
                const checkedAttr = (isEnabled && state.sel_levels.has(lvl)) ? 'checked' : '';

                html += `<div class="checkbox-item" id="div_lvl_${lvl}">
                            <input type="checkbox" value="${lvl}" ${disabledAttr} ${checkedAttr} onchange="onLvlSelect()">
                            <label class="${disabledAttr}">${lvl}</label>
                         </div>`;
            });

            container.innerHTML = html;
            msg.innerText = allDisabled ? "(Make a selection above to enable checkboxes)" : "";
            generateOutputs();
        }

        function onLvlSelect() {
            const checkboxes = document.querySelectorAll('#levels-content input[type="checkbox"]');
            state.sel_levels.clear();
            checkboxes.forEach(cb => {
                if(cb.checked) state.sel_levels.add(cb.value);
            });
            generateOutputs();
        }

        function renderMonthsPanel() {
            const container = document.getElementById('months-content');
            const msg = document.getElementById('mon-msg');
            
            let allDisabled = true;
            let html = '';

            jsonData.arr_mon.forEach(mon => {
                let isEnabled = false;
                for (let v of state.sel_vars) {
                     if (checkTreeExistence(v, null, mon)) {
                         isEnabled = true;
                         break;
                     }
                }

                if (isEnabled) allDisabled = false;
                const disabledAttr = isEnabled ? '' : 'disabled';
                if (!isEnabled && state.sel_months.has(mon)) state.sel_months.delete(mon);
                const checkedAttr = (isEnabled && state.sel_months.has(mon)) ? 'checked' : '';

                html += `<div class="checkbox-item" id="div_mon_${mon}">
                            <input type="checkbox" value="${mon}" ${disabledAttr} ${checkedAttr} onchange="onMonSelect()">
                            <label class="${disabledAttr}">${mon}</label>
                         </div>`;
            });

            container.innerHTML = html;
            msg.innerText = allDisabled ? "(Make a selection above to enable checkboxes)" : "";
            generateOutputs();
        }

        function onMonSelect() {
            const checkboxes = document.querySelectorAll('#months-content input[type="checkbox"]');
            state.sel_months.clear();
            checkboxes.forEach(cb => {
                if(cb.checked) state.sel_months.add(cb.value);
            });
            generateOutputs();
        }

        // --- HELPER UI ---
        function selectAll(containerId, isSelect) {
            const selector = `#${containerId} input[type="checkbox"]`;
            const inputs = document.querySelectorAll(selector);
            inputs.forEach(input => {
                if (!input.disabled) {
                    input.checked = isSelect;
                }
            });

            if (containerId === 'provider_table') onProviderSelect();
            if (containerId === 'version_table') onVersionSelect();
            if (containerId === 'vars-content') onVarSelect();
            if (containerId === 'levels-content') onLvlSelect();
            if (containerId === 'months-content') onMonSelect();
        }

        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            el.select();
            document.execCommand('copy');
        }

        // --- GENERATION & OUTPUTS ---

        function entryValidation(af_sss_cccc_mm_ii, varname, lvl, mon) {
            const p = af_sss_cccc_mm_ii.split(':'); 
            const af=p[0], sss=p[1], cccc=p[2], mm=p[3], ii=p[4];

            const varNode = jsonData.data?.[af]?.[sss]?.[cccc]?.[mm]?.[ii]?.[varname];
            if (!varNode) return false;

            // if ((lvl === '' || lvl === '*') && (mon === '' || mon === '*')) return true;

            // Use cleanSplit here as well to avoid empty strings in checks
            const hasLvl = (lvl === '' || lvl === '*' || cleanSplit(varNode.lvllist).includes(lvl));
            const hasMon = (mon === '' || mon === '*' || cleanSplit(varNode.monlist).includes(mon));

            return hasLvl && hasMon;
        }

        function filenameCreation(af_sss_cccc_mm_ii, varname, lvl, mon) {
            const p = af_sss_cccc_mm_ii.split(':'); 
            const af=p[0], sss=p[1], cccc=p[2], mm=p[3], ii=p[4];

            if (af === 'analyses') {
                if (lvl === 'surface') {
                    return `${varname}_${cccc}_sl_${mon}.grib2`;
                } else {
                    return `${varname}_${lvl}_${cccc}_pl_${mon}.grib2`;
                }
            } else if (af === 'forecasts') {
                 if (lvl === 'surface') {
                    return `${varname}_${sss}_${cccc}_${mm}_${ii}_sl_${mon}.grib2`;
                } else {
                    return `${varname}_${lvl}_${sss}_${cccc}_${mm}_${ii}_pl_${mon}.grib2`;
                }
            }
            return "";
        }

        function pathCreation(af_sss_cccc_mm_ii, varname) {
            const p = af_sss_cccc_mm_ii.split(':'); 
            const af=p[0], sss=p[1], cccc=p[2], mm=p[3], ii=p[4];

            if (af === 'analyses') {
                return `${af}/${cccc}/${varname}`;
            } else if (af === 'forecasts') {
                return `${af}/${sss}/${cccc}/${mm}_${ii}/${varname}`;
            }
            return "";
        }

        function vpathCreation(varname, lvl) {
            let l = (lvl === 'surface') ? '1' : lvl;
            return `vindex/${varname}/${l}`;
        }

        function generateOutputs() {
            const pathsArea = document.getElementById('out-paths');
            // const vpathsArea = document.getElementById('out-vpaths');
            const pathCount = document.getElementById('path-count');
            // const vpathCount = document.getElementById('vpath-count');

            pathsArea.value = '';
            // vpathsArea.value = '';

            if (state.sel_version.size === 0 || 
                state.sel_vars.size === 0 || 
                state.sel_levels.size === 0 || 
                state.sel_months.size === 0) {
                    const msg = "# Select at least one option in every selection box above";
                    pathsArea.vaue = msg;
                    // vpathsArea.value = msg;
                    pathCount.innerText = "(0 items)";
                    // vpathCount.innerText = "(0 items)";
                    return;
            }

            let pathList = [];
            // let vpathList = [];
            let nfiles = 0;
            
            for (let ver of state.sel_version) {
                const p = ver.split(':'); 
                const af=p[0], sss=p[1], cccc=p[2], mm=p[3], ii=p[4];
                for (let v of state.sel_vars) {
                    if (!jsonData.data[af][sss][cccc][mm][ii][v]) continue;
                    const varMonthList = cleanSplit(jsonData.data[af][sss][cccc][mm][ii][v]['monlist']);
                    const selMonthList = (state.sel_months.size >= varMonthList.length) ? ['*'] : state.sel_months ;
                    const varLevelList = cleanSplit(jsonData.data[af][sss][cccc][mm][ii][v]['lvllist']);
                    const selLevelList = (state.sel_levels.size >= varLevelList.length) ? ['*'] : state.sel_levels ;

                    for (let l of selLevelList) {
                        for (let m of selMonthList) {
                            if (entryValidation(ver, v, l, m)) {
                                const fname = filenameCreation(ver, v, l, m);
                                // const pDir = pathCreation(ver, v);
                                // pathList.push(`/${pDir}/${fname}`);
                                pathList.push(`${fname}`);
                            }
                        }
                    }
                    for (let l of state.sel_levels) {
                        for (let m of state.sel_months) {
                            if (entryValidation(ver, v, l, m)) nfiles++;
                        }
                    }
                }
            }

            const wgetcmdbase = 'wget -e robots=off -r --no-parent -A';
            const urlbase = 'http://hpfx.collab.science.gc.ca/~swpm001/WP-MIP/'+state.af;
            let wgetcmd = '';
            const outerSize = 30;
            const innerSize = 5;
            for (let i = 0; i < pathList.length; i += outerSize) {
                const bigChunk = pathList.slice(i, i + outerSize);
                wgetcmd += wgetcmdbase + ' "\\\n';
                for (let j = 0; j < bigChunk.length; j += innerSize) {
                    const smallChunk = bigChunk.slice(j, j + innerSize);
                    wgetcmd += smallChunk.join(',');
                    if (j < bigChunk.length-1) wgetcmd += ',';
                    wgetcmd += '\\\n';
                }
                wgetcmd += '" ' + urlbase + '\n\n';
            }
            pathCount.innerText = `(${pathList.length} patterns ; ${nfiles} files)`;
            pathsArea.value = wgetcmd;
        }

    </script>
    </main>
</body>
</html>

