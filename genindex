#!/gpfs/fs3c/eccc/mrd/rpnatm/swpm001/installed/venv/bin/python
import glob, os, re, sys
from datetime import datetime
from collections import defaultdict

# Contributor name mapping
namemap = defaultdict(dict)
namemap = dict({'cwao':{'name':'ECCC', 'long':'ECCC'},
                'ecmf':{'name':'ECMWF', 'long':'ECMWF'},
                'kwbc':{'name':'NOAA', 'long':'NOAA'},
                'rksl':{'name':'KMA/KIAPS', 'long':'KMA_KIAPS'},
                'ammc':{'name':'BoM', 'long':'BoM'},
                'babj':{'name':'CMA', 'long':'CMA'},
                'sbsj':{'name':'CPTEC', 'long':'CPTEC_INPE'},
                'edzw':{'name':'DWD', 'long':'DWD'},
                'vabb':{'name':'IMD', 'long':'IMD'},
                'rjtd':{'name':'JMA', 'long':'JMA'},
                'egrr':{'name':'UKMO', 'long':'UKMO'},
                'enmi':{'name':'MetNo', 'long':'MetNo'},
                'rums':{'name':'RAS', 'long':'RAS'}})

# Variable name mapping
varmap = {'pl':defaultdict(dict), 'sl':defaultdict(dict)}
varmap['pl'] = dict({'t':{'long':'Temperature', 'units':'K'},
                     'q':{'long':'Specific Humidity', 'units':'kg kg<sup>-1</sup>'},
                     'u':{'long':'U-Component Wind', 'units':'m s<sup>-1</sup>'},
                     'v':{'long':'V-Component Wind', 'units':'m s<sup>-1</sup>'},
                     'gp':{'long':'Geopential Height', 'units':'m'}})
varmap['sl'] = dict({'msl':{'long':'Mean Sea Level Pressure', 'units':'Pa'},
                     'sp':{'long':'Surface Pressure', 'units':'Pa'},
                     '2t':{'long':'Screen-Level Temperature', 'units':'K'},
                     '2sh':{'long':'Screen-Level Specific Humidity', 'units':'kg kg<sup>-1</sup>'},
                     '2d':{'long':'Screen-Level Dewpoint', 'units':'K'},
                     'sst':{'long':'Sea Surface Temperature', 'units':'K'},
                     '10u':{'long':'Anemometer-Level U-Component Wind', 'units':'m s<sup>-1</sup>'},
                     '10v':{'long':'Anemometer-Level V-Component Wind', 'units':'m s<sup>-1</sup>'},
                     'tp':{'long':'Precipitation Accumulation', 'units':'kg m<sup>-2</sup>'},
                     'ci':{'long':'Sea Ice Fraction', 'units':''},
                     'sithink':{'long':'Sea Ice Thickness', 'units':'m'},
                     'tcc':{'long':'Total Cloud Cover', 'units':'%'},
                     'lcc':{'long':'Low Cloud Cover', 'units':'%'},
                     'mcc':{'long':'Mid Cloud Cover', 'units':'%'},
                     'hcc':{'long':'High Cloud Cover', 'units':'%'},
                     'ssr':{'long':'Surface Net Shortwave Accumulation', 'units':'J m<sup>-2</sup>'},
                     'ssrd':{'long':'Surface Downwelling Shortwave Accumulation', 'units':'J m<sup>-2</sup>'},
                     'str':{'long':'Surface Net Longwave Accumulation', 'units':'J m<sup>-2</sup>'},
                     'strd':{'long':'Surface Downwelling Longwave Accumulation', 'units':'J m<sup>-2</sup>'},
                     'str':{'long':'TOA Net Shortwave Accumulation', 'units':'J m<sup>-2</sup>'},
                     'tisr':{'long':'TOA Downwelling Shortwave Accumulation', 'units':'J m<sup>-2</sup>'},
                     'ttr':{'long':'TOA Net Longwave Accumulation', 'units':'J m<sup>-2</sup>'},
                     'sshf':{'long':'Time-Integrated Surface Sensible Heat Flux', 'units':'J m<sup>-2</sup>'},
                     'shlf':{'long':'Time-Integrated Surface Latent Heat Fklux', 'units':'J m<sup>-2</sup>'}})

# Level name mapping
levmap = {'sl':'Single-Level', 'pl':'Pressure-Level'} 
                    
# Basic setup
ofile='index_test.html'
exp = 'WP-MIP'
base = os.path.join('/home/swpm001/public_html', exp)
fbase = os.path.join(base, 'forecasts')
html_path = '/home/swpm001/public_html'
test_pl = 'gh'
test_sl = '2t'
model_defaults = defaultdict(dict)
model_defaults = dict({'ai':{'link':'-', 'path':[]},
                       'hy':{'link':'-', 'path':[]},
                       'pm':{'link':'-', 'path':[]}})
edit_warning = '<!-- THIS FILE IS AUTOMATICALLY GENERATED BY THE genindex TOOL.  DO NOT EDIT THIS FILE!!! -->'

class Contrib(dict):

    def __init__(self, base, stream):
        contrib_pl = self._getContrib(base, stream, test_pl)
        contrib_sl = self._getContrib(base, stream, test_sl)    
        contrib = self._joinContrib(contrib_pl, contrib_sl)    
        outstr = ''
        paths = []
        for centre in sorted(contrib.keys()):
            try:
                name = namemap[centre]['name']
            except KeyError:
                name = centre
            c = contrib[centre]
            outstr += '<tr><td>'+centre+'</td><td>'+name+self._addtd(c['pl'])+self._addtd(c['sl'])+'\n'
            paths.extend(self._addpath(c['pl']))
            paths.extend(self._addpath(c['sl']))
        self.outstr = outstr
        self.paths = []
        for p in paths:
            if p:
                self.paths.extend(p)

    def _getContrib(self, base, stream, testfld):
        if not os.path.exists(base):
            sys.stderr.write('Cannot find '+base+'.  Run this application from the hpfx server.\n')
            sys.exit(1)
        if stream is None:
            dirs = glob.glob(os.path.join(base, '*', testfld), recursive=True)
            contrib = {}
            for dir in dirs:
                path = re.split('/', dir)
                centre = path[-2]
                path = os.path.join(exp, os.path.basename(base), centre)
                if centre not in contrib.keys():
                    contrib[centre] = defaultdict(dict)
                contrib[centre] = {'pm':{'link':'<a href="'+path+'">Available</a>', 'path':[path]}}
            for centre in contrib.keys():
                contrib[centre] = dict(contrib[centre])
        else:
            dirs = glob.glob(os.path.join(base, stream, '*/*', testfld), recursive=True)
            contrib = {}
            for dir in dirs:
                path = re.split('/', dir)
                (ty, ver) = re.split('_', path[-2])
                centre = path[-3]
                path = os.path.join(exp, os.path.basename(base), stream, centre, ty+'_'+ver)
                if centre not in contrib.keys():
                    contrib[centre] = defaultdict(dict)
                try:
                    contrib[centre][ty]['link'] += ', <a href="'+path+'">v'+ver+'</a>'
                    contrib[centre][ty]['path'].append(path)
                except KeyError:
                    contrib[centre][ty] = defaultdict(dict)
                    contrib[centre][ty] = {'link':'<a href="'+path+'">v'+ver+'</a>', 'path':[path]}
            for centre in contrib.keys():
                for ty in model_defaults.keys():
                    if ty not in contrib[centre]:
                        contrib[centre][ty] = {'link':'-', 'path':[]}
                contrib[centre] = dict(contrib[centre])
        return(dict(contrib))

    def _joinContrib(self, cpl, csl):
        contrib = {}
        for centre in set(list(cpl.keys()) + list(csl.keys())):
            try:
                pl = cpl[centre]
            except KeyError:
                pl = model_defaults
            try:
                sl = csl[centre]
            except KeyError:
                sl = model_defaults
            contrib[centre] = {'pl':pl, 'sl':sl}
        return(contrib)

    def _addtd(self, d):
        tdstr = ''
        for ty in sorted(model_defaults):
            try:
                tdstr += '<td>'+d[ty]['link']+'</td>'
            except KeyError:
                pass
        return(tdstr)

    def _addpath(self, p):
        paths = []
        for ty in model_defaults:
            try:
                paths.append(p[ty]['path'])
            except KeyError:
                pass
        return(paths)

def pathIndex(paths):
    fdin = open(os.path.join(os.path.abspath(os.path.dirname(__file__)), 'etc/index_model.tmpl'), "rt")
    inlines = fdin.readlines()
    fdin.close()
    for p in paths:
        pitems = re.split('/', p)
        centre = pitems[-2]
        for lev in levmap.keys():
            with open(os.path.join(html_path, p, 'index_'+lev+'.html'), "w") as fdout:
                print(levmap[lev])
                for line in inlines:
                    tmpstr = ' '.join(['<center><h1>', namemap[centre]['long'], levmap[lev], 'Forecasts</h1></center>'])
                    line = line.replace('TITLE', tmpstr)
                    line = line.replace('EDIT_WARNING', edit_warning)
                    fdout.write(line)
                  

# OIC Contributions
oic = Contrib(fbase, 'oic')

# SIC Contributions
sic = Contrib(fbase, 'sic')

# Available analyses
anl = Contrib(os.path.join(base, 'analyses'), None)

# Create new index file
with open(os.path.join(os.path.abspath(os.path.dirname(__file__)), 'etc/index.tmpl'), "rt") as fdin:
    with open(os.path.join(html_path, ofile), "wt") as fdout:
        for line in fdin:
            line = line.replace('OIC_TABLE_DATA', oic.outstr)
            line = line.replace('SIC_TABLE_DATA', sic.outstr)
            line = line.replace('ANALYSES_TABLE_DATA', anl.outstr)
            line = line.replace('GEN_DATETIME', datetime.utcnow().strftime('%H%M UTC %d %h %Y'))
            line = line.replace('EDIT_WARNING', edit_warning)
            fdout.write(line)

# Create model-specific index files
pathIndex(oic.paths)

